<html>

<head>
    <title>FlaskChat</title>
    <style>
        .div-message {
            border-style: solid;
        }
    </style>
</head>

<body>
    <h1>Welcome to Flask Chat</h1>

    <!-- Form that contains message and sender input options. -->
    <form action="/messages" method="POST">
        <label>Sender</label>
        <br>
        <input type="text" name="sender">
        <br>
        <label>Message</label>
        <br>
        <textarea name="message"></textarea>
        <br>
        <input type="submit" value="Send">
    </form>

    <br>

    <h2>Messages</h2>
    <div id="ul-messages"></div>

</body>

<!-- Dependencies -->
<!-- 1. jQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!-- 2. Icons for edit and delete -->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<!-- 3. Our js file with code to send requests to backend -->
<script src="../static/custom_ajax.js"></script>

<script>
    function populateDivWithEditMessage(div) {
        // TODO: Make all vars with var.
        var editDiv = $('<div class="edit_div">');
        var textarea = div.find('textarea')[0];

        if (textarea == null) {
            var messageBox = div.find('.message').first();
            var textarea = $('<textarea>');
            textarea.val(messageBox.text());
            
            var editComplete = $('<button style="font-size:18px"><i class="material-icons">done</i></button>');
            var editDiscard = $('<button style="font-size:18px"><i class="material-icons">cancel</i></button>');

            editComplete.on('click', async function (event) {
                var ID = div.attr('id');
                var newMessage = textarea.val();

                var response = await sendPatchMessage(ID, newMessage);
                var success = response['success'];
                if (success) {
                    messageBox.text(newMessage);
                    editDiv.remove();
                }
            });

            editDiscard.on('click', async function (event) {
                editDiv.remove();
            })

            editDiv.append($('<br><br>'));
            editDiv.append(textarea);
            editDiv.append($('<br>'));
            editDiv.append(editComplete);
            editDiv.append(editDiscard);

            div.append(editDiv);
        }
    }

    function populateDivWithMessage(div, message) {
        div.empty();

        title = $('<h3 class="message">');
        subtitle = $('<h5 class="sender">');

        title.text(message.message);
        subtitle.text(message.sender);

        div.append(title);
        div.append(subtitle);

        edit = $('<button style="font-size:18px"><i class="material-icons">mode_edit</i></button>');
        edit.on('click', (event) => {
            // TODO: Remove the testing append.
            div = $(`div #${message.ID}`);
            // test = $('<h2>Testing</h2>');
            // div.append(test);
            populateDivWithEditMessage(div);
        })
        div.append(edit);

        _delete = $('<button style="font-size:18px"><i class="material-icons">delete</i></button>');
        _delete.on('click', async (event) => {
            response = await sendDeleteMessage(message.ID);

            success = response['success']
            if (success === true) { // TODO: if (success) everywhere
                syncMessages();
            } else {
                // TODO: Must also catch exceptions when no response is received.
                alert('Error deleting message');
            }
        });
    }
</script>

<script>
    /**
     * Populates the list (div tag) with the passed list of messages
     * Each message in messages looks like 
     * {
     *  "ID": 5,
     *  "message": "Sample message",
     *  "sender": "John Doe"
     * }
     */
    function populate_messages(messages) {
        ul = $('#ul-messages');
        ul.empty();
        messages.forEach(message => {
            div = $(`<div id="${message.ID}" class="div-message">`);
            populateDivWithMessage(div, message);
            div.append(_delete);

            ul.append(div);
            ul.append($('<br>'));
        });
    }
</script>

<script>
    /**
     * Sends an AJAX request GET /messages to get the messages
     * Sample response:
     * {
        "messages": [
            {
                "ID": 3,
                "message": "Hi there",
                "sender": "Steve"
            },
            {
                "ID": 2,
                "message": "Hello",
                "sender": "Mike the Tiger"
            },
            {
                "ID": 1,
                "message": "Hi",
                "sender": "Mike the Tiger"
            }
        ],
            "success": true
    }
     */
    async function syncMessages() {
        response = await sendGetMessages();

        success = response['success'];
        if (success === true) {
            populate_messages(response['messages']);
        } else {
            alert('Error downloading messages');
        }
    }
</script>

<script>
    /**
     * Intercepts the submit action on the form and overrides it with a custom action
     */
    form = $('form');
    form.on('submit', async function (event) {
        event.preventDefault();

        message = form.find("textarea[name='message']").val();
        sender = form.find("input[name='sender']").val();

        response = await sendPostMessage(message, sender);

        var success = response['success']
        if (success === true) {
            syncMessages();
        } else {
            alert('Error sending message');
        }
    });
</script>

<script>
    // Calling syncMessages() once when the page starts to get the latest messages.
    syncMessages();
</script>

</html>